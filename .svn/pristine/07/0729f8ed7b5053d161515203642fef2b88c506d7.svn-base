package core.services;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import core.daos.BulkMemoDumpDao;
import core.daos.MeetingInfoDao;
import core.daos.MemoDao;
import core.daos.MemoRecipientDao;
import core.entities.*;
import core.exceptions.ForbiddenException;
import core.exceptions.InternalServerErrorException;
import core.utils.Constants;
import core.utils.Enums;
import core.utils.Enums.*;
import core.utils.ThreadContext;
import org.apache.commons.lang3.RandomStringUtils;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.env.Environment;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
public class MeetingServiceImpl implements MeetingService {
	final static Logger logger = LoggerFactory.getLogger(MeetingServiceImpl.class);

	@Autowired
	private Environment env;

	@Autowired
	private MeetingInfoDao meetingInfoDao;

	@Autowired
	private CacheService cacheService;

	@Autowired
	private RecordingService recordingService;

    @Transactional
	@Override
		public Integer createMeeting(Integer groupId, Boolean alwaysCreateNewMeeting, Integer currentUserId, Byte meetingType, Integer to) {
    	 Integer meetingId= null;
    	if(!alwaysCreateNewMeeting) {
    	 	 meetingId = meetingInfoDao.getExistingMeetingId(groupId.longValue());
    	}   
    	if(meetingId != null){
    		return meetingId;
		} else {
			Meeting meeting = getMeeting(groupId, currentUserId, meetingType, to);
			meetingInfoDao.create(meeting);
			return meeting.getId();
		}
		}

	private Meeting getMeeting(Integer groupId, Integer currentUserId, Byte meetingType, Integer to) {
		Meeting meeting = new Meeting();
		meeting.setActive(true);
		meeting.setMeetingRating((byte)0);
		meeting.setStartDate(0L);
		meeting.setEndDate(0L);
		meeting.setCreatedDate(System.currentTimeMillis());
		meeting.setStartDate(System.currentTimeMillis());
		meeting.setFrom(currentUserId);
		//getGuestUserId from group Cache
		meeting.setTo(to);
		meeting.setLastPingDate(null);
		meeting.setGroupId(groupId.longValue());
		meeting.setMeetingStatus(VideoCallStatus.Created.getId().byteValue());
		meeting.setMeetingType(meetingType);
		meeting.setUpdatedDate(System.currentTimeMillis());
		meeting.setUpdatedById(currentUserId);
		return meeting;
	}

	@Transactional
    @Override
	public Integer createRecording(Integer groupId, Integer meetingId, Byte recordingType, Byte recordingMethod, Integer currentUserId, Integer to, Boolean alwaysCreateNewRec){
		Integer	recordingId = null;
		if(!alwaysCreateNewRec) {
			Recording	recording= recordingService.getRecordingByMeetingId(meetingId);
			return recording.getId();
		}
		if(recordingId == null) {
			Recording recording = new Recording(currentUserId, to, System.currentTimeMillis(), recordingType.byteValue(),
					RecordingStage.Started.getId(), groupId, meetingId, (byte)1, recordingMethod);
			recording = recordingService.createVideoRecording(recording);
			return recording.getId();
		}
    	return recordingId;
	}


	@Override
	public Meeting getMeetingDetails(Integer meetingId) {
		logger.info("get meeting details start: {}",meetingId);
		try {
           Meeting meeting = meetingInfoDao.findOne(meetingId);
			return meeting;
		}  catch (Exception e) {
			throw new InternalServerErrorException(ErrorCode.Internal_Server_Error,
					"Failed to get meeting "+ e);
		}

	}
	
	



}


